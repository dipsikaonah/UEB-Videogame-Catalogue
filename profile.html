<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Profile — QUEST</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="style.css" />
        <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            function Nav() {
                return (
                    <nav>
                        <ul>
                            <li>
                                <img href="#" className="nav-logo" src="images/logo.jpg" alt="Logo" />
                            </li>
                            <li>
                                <a id="title" href="landing.html">QUEST</a>
                            </li>
                            <li className="nav-spacer">
                                <a className="navitem" href="games.html">Browse Games</a>
                            </li>
                            <li>
                                <a className="navitem" href="privacy.html">Our Policy</a>
                            </li>
                            <li>
                                <input type="search" placeholder=" Search..." />
                            </li>
                            <li>
                                <button id="loginBtn">Log in</button>
                            </li>
                            <li>
                                <button id="signupBtn" className="button-2">Sign Up</button>
                            </li>
                        </ul>
                    </nav>
                );
            }

            function Footer() {
                return (
                    <footer>
                        <div className="footer-columns">
                            <div className="footer-col">
                                <h2>QUEST</h2>
                            </div>
                            <div className="footer-col">
                                <a href="#">About Us</a>
                                <br />
                                <a href="#">Contact Us</a>
                            </div>
                            <div className="footer-col">
                                <a href="#">Terms of Service</a>
                                <br />
                                <a href="privacy.html">Privacy Policy</a>
                            </div>
                        </div>
                        <br />
                        <div className="footer-bottom">
                            © 2025 Quest. All rights reserved. Game data and artwork belong to their respective owners.
                        </div>
                    </footer>
                );
            }

            function Profile() {
                const [games, setGames] = useState([]);
                const [saved, setSaved] = useState([]);
                const [selected, setSelected] = useState('');

                // LocalStorage helpers matching script.js behaviour
                function getUsers() {
                    try { return JSON.parse(localStorage.getItem('users') || '[]'); }
                    catch (e) { return []; }
                }
                function setUsers(u) { localStorage.setItem('users', JSON.stringify(u)); }
                function getCurrentUserKey() { return localStorage.getItem('currentUser') || null; }
                function findUser(key) { if (!key) return null; const users = getUsers(); return users.find(u => u.username === key || u.email === key) || null; }

                function getSavedGamesLocal() {
                    const key = getCurrentUserKey();
                    const user = findUser(key);
                    if (user) return user.profileGames || [];
                    try { return JSON.parse(localStorage.getItem('profileGames') || '[]'); }
                    catch (e) { return []; }
                }

                function setSavedGamesLocal(list) {
                    const key = getCurrentUserKey();
                    const users = getUsers();
                    if (key) {
                        const idx = users.findIndex(u => u.username === key || u.email === key);
                        if (idx >= 0) {
                            users[idx].profileGames = list;
                            setUsers(users);
                        }
                    } else {
                        localStorage.setItem('profileGames', JSON.stringify(list));
                    }
                }

                useEffect(() => {
                    fetch('games.json')
                        .then((r) => r.json())
                        .then((data) => {
                            setGames(data.slice(0, 50));
                            if (data && data.length) setSelected(data[0].name || '');
                            // load saved from localStorage (in case games were added from other pages)
                            const initialSaved = getSavedGamesLocal();
                            setSaved(initialSaved);
                        })
                        .catch(() => {
                            setGames([]);
                        });
                }, []);

                function addGame() {
                    if (!selected) return;
                    const exists = saved.find((g) => g.name === selected);
                    if (exists) return;
                    const gameObj = games.find((g) => g.name === selected);
                    if (!gameObj) return;
                    const newSaved = [gameObj, ...saved];
                    setSaved(newSaved);
                    setSavedGamesLocal(newSaved);
                }

                function removeGame(name) {
                    const filtered = saved.filter(s => s.name !== name);
                    setSaved(filtered);
                    setSavedGamesLocal(filtered);
                }

                function imageFor(g) {
                    return g.main_image_url || g.image1 || g.main_image2_url || 'images/games/details/default.jpg';
                }

                const currentKey = getCurrentUserKey();
                const currentUser = findUser(currentKey);
                const displayName = (currentUser && (currentUser.username || currentUser.email)) || 'User';

                return (
                    <section className="profile-container">
                        <div className="profile-header">
                            <div className="profile-top">
                                <img src="images/joker pfp.jpg" className="profile-avatar" alt="avatar" />
                                <div className="profile-user-info">
                                    <h2 className="accent-pink">{displayName}</h2>
                                    <button>Edit Profile</button>
                                </div>
                            </div>

                            <div className="profile-stats">
                                <p>
                                    <span>{103}</span>Liked Games
                                </p>
                                <p>
                                    <span>{5}</span>Lists
                                </p>
                                <p>
                                    <span id="savedCount">{saved.length}</span>Games Saved
                                </p>
                            </div>
                        </div>

                        <div className="lists-header">
                            <h2>My Lists</h2>
                            <button className="create-list-btn"> Create a List</button>
                        </div>

                        <div className="add-game-panel mb-4">
                            <br />
                            <label htmlFor="gameSelect" className="form-label text-white">
                                Add a game:
                            </label>
                            <div className="d-flex gap-2">
                                <select id="gameSelect" className="form-select" style={{ flex: '0 1 40%' }} value={selected} onChange={(e) => setSelected(e.target.value)}>
                                    {games.length === 0 && <option>Loading...</option>}
                                    {games.map((g, idx) => (
                                        <option key={idx} value={g.name}>
                                            {g.name}
                                        </option>
                                    ))}
                                </select>
                                <button id="addGameBtn" onClick={addGame}>
                                    Add to My Games
                                </button>
                            </div>
                        </div>

                        <div id="lists">
                            <div id="savedGames" className="saved-games">
                                {saved.length === 0 && <p style={{ color: 'white' }}>No saved games yet.</p>}
                                {saved.map((g, i) => (
                                    <div key={i} className="card bg-transparent border-secondary" style={{ marginBottom: 12 }}>
                                        <div className="card-body d-flex align-items-center gap-3">
                                            <img src={imageFor(g)} alt={g.name} style={{ width: 80, height: 80, objectFit: 'cover', borderRadius: 4 }} />
                                            <div style={{ flex: 1 }}>
                                                <h6 className="card-title text-white mb-1">{g.name}</h6>
                                                <p className="card-text text-secondary small mb-0">{(g.genres && g.genres[0]) || ''}</p>
                                            </div>
                                            <button className="btn btn-sm btn-outline-danger" onClick={() => removeGame(g.name)}>Remove</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>
                );
            }

            function App() {
                return (
                    <div>
                        <Nav />
                        <Profile />
                        <Footer />
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        </script>
    </body>
</html>
